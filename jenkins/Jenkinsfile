pipeline {
    agent any

    environment {
      IMAGE_NAME = 'peerawitp/jenkins-lab'
      DOCKERFILE = './docker/Dockerfile'
    }

    stages {
      stage('Run tests') {
        agent {
          docker { image 'oven/bun:1.2-alpine' }
        }
        steps {
          script {
            sh 'bun test'
          }
        }
      }

      stage('Build and push docker image') {
        steps {
          script {
              docker.withRegistry('', 'docker-hub-peerawitp') {
                def dockerImage = docker.build("${IMAGE_NAME}:${env.BUILD_ID}", "-f ${DOCKERFILE} .")
                dockerImage.push()
                dockerImage.push('latest')
              }
          }
        }
      }
    }
}
